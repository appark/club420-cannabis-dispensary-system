<!-- COMPLETE Club420 System - MOBILE LOCATIONS + SHOP COLLAPSE -->

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* ULTRA-FAST TRANSITIONS - NO FLASH */
  body {
    background: #000 !important;
  }

  body, html {
    background-color: #000 !important;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: -1;
  }

  /* REDESIGNED MODAL - APOTHECARIUM STYLE */
  .club420-modal {
    position: fixed !important;
    z-index: 999999 !important;
    top: 0 !important; 
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(25px) saturate(1.5);
    -webkit-backdrop-filter: blur(25px) saturate(1.5); /* Safari support */
    display: none !important;
    justify-content: center !important;
    align-items: center !important;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    padding: 1rem;
    margin: 0 !important;
    box-sizing: border-box !important;
  }

  .club420-modal.show {
    display: flex !important;
    animation: fadeIn 0.6s ease-in-out;
  }

  .club420-modal-box {
    background: rgba(20, 20, 20, 0.95);
    padding: 2.5rem 3rem;
    border-radius: 24px;
    text-align: center;
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
    position: relative !important;
    z-index: 1000000 !important;
    margin: auto !important;
    box-sizing: border-box !important;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* LOGO STYLING */
  .club420-modal-box img {
    max-width: 240px;
    height: auto;
    margin-bottom: 1.5rem;
    filter: brightness(1.1);
  }

  /* TYPOGRAPHY - APOTHECARIUM STYLE */
  .club420-modal-box h2 {
    color: #ffffff;
    font-size: 2.8rem;
    font-weight: 300;
    margin-bottom: 0.25rem;
    letter-spacing: 0.5px;
  }

  .club420-modal-box .age-confirm-title {
    color: #f2ac1d;
    font-size: 1.6rem;
    font-weight: 400;
    margin-bottom: 1.5rem;
    letter-spacing: 0.3px;
  }

  .club420-modal-box .age-confirm-text {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 2rem;
    font-weight: 300;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .club420-modal-box .legal-text {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    line-height: 1.5;
    margin-top: 1.5rem;
    font-weight: 300;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  /* BUTTON CONTAINER */
  .age-buttons {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin: 2rem auto 1.5rem auto;
    max-width: 400px;
  }

  /* REDESIGNED BUTTONS - APOTHECARIUM STYLE */
  .club420-btn {
    flex: 1;
    max-width: 180px;
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    min-width: 140px;
  }

  .club420-btn--yes {
    background: #ffffff;
    color: #000000;
  }

  .club420-btn--no {
    background: #ffffff;
    color: #000000;
  }

  /* BUTTON HOVER EFFECTS */
  .club420-btn--yes:hover {
    background: #f2ac1d;
    color: #000000;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(242, 172, 29, 0.4);
  }

  .club420-btn--no:hover {
    background: #666666;
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 102, 102, 0.3);
  }

  .club420-btn:active {
    transform: translateY(0px) scale(0.98);
  }

  /* STORE SELECTION MODAL - UPDATED STYLING */
  .store-option {
    display: block;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    cursor: pointer;
    text-align: left;
    transition: all 0.3s ease;
    user-select: none;
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
  }

  .store-option:hover {
    border-color: #f2ac1d;
    background: rgba(242, 172, 29, 0.1);
  }

  .store-option:active {
    transform: scale(0.98);
  }

  .store-option strong {
    color: #ffffff;
    font-size: 1.1rem;
  }

  #enter-site-button {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
    border: none;
    border-radius: 50px;
    background: rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.7);
    font-weight: 600;
    cursor: not-allowed;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 1rem;
  }

  #enter-site-button:not(:disabled) {
    background: #f2ac1d;
    color: #000000;
    cursor: pointer;
  }

  #enter-site-button:not(:disabled):hover {
    background: #e09b0a;
    transform: scale(1.02);
  }

  #enter-site-button:not(:disabled):active {
    transform: scale(0.98);
  }

  /* MOBILE RESPONSIVENESS */
  @media screen and (max-width: 768px) {
    .club420-modal-box {
      padding: 2.5rem 1.5rem 2rem 1.5rem;
      margin: 1rem;
      width: 90%;
      max-width: 400px;
    }
    
    .club420-modal-box img {
      max-width: 200px;
      margin-bottom: 1.5rem;
    }
    
    .club420-modal-box h2 {
      font-size: 2.6rem;
      margin-bottom: 0.25rem;
    }
    
    .club420-modal-box .age-confirm-title {
      font-size: 1.6rem;
      margin-bottom: 1.25rem;
    }
    
    .age-buttons {
      flex-direction: column;
      gap: 1rem;
      max-width: 300px;
    }
    
    .club420-btn {
      max-width: none;
      min-width: auto;
    }
  }

  @media screen and (max-width: 480px) {
    .club420-modal-box {
      padding: 2.75rem 1.25rem 2rem 1.25rem;
      margin: 0.75rem;
      width: 95%;
      max-width: 350px;
    }
    
    .club420-modal-box img {
      max-width: 220px;
      margin-bottom: 1.75rem;
    }
    
    .club420-modal-box h2 {
      font-size: 2.4rem;
      margin-bottom: 0.25rem;
    }
    
    .club420-modal-box .age-confirm-title {
      font-size: 1.5rem;
      margin-bottom: 1.25rem;
    }
    
    .club420-modal-box .age-confirm-text {
      font-size: 0.95rem;
    }
  }

  /* ULTRA-FAST Page transition overlay - ALWAYS VISIBLE */
  .club420-page-transition {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: linear-gradient(135deg, #000 0%, #333 100%);
    z-index: 999999 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    opacity: 0;
    visibility: hidden;
    transition: none !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
  }
  
  .club420-page-transition.active {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
    transition: none !important;
  }
  
  .transition-content {
    text-align: center;
    color: white;
    font-family: 'Inter', sans-serif;
    position: relative;
    z-index: 1000000;
    max-width: 90vw;
    padding: 2rem;
  }
  
  .transition-logo {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  
  .transition-logo img {
    max-width: 70%;
    max-height: 70%;
    object-fit: contain;
  }
  
  .logo-desktop {
    display: block;
  }
  
  .logo-mobile {
    display: none;
  }
  
  @media screen and (max-width: 768px) {
    .transition-logo {
      width: 70px;
      height: 70px;
      margin-bottom: 15px;
    }
    
    .transition-text {
      font-size: 20px;
    }
    
    .transition-subtext {
      font-size: 14px;
    }
    
    .logo-desktop {
      display: none;
    }
    
    .logo-mobile {
      display: block;
    }
  }
  
  .transition-text {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 12px;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  
  .transition-subtext {
    font-size: 16px;
    opacity: 0.9;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  
  /* ULTRA-FAST Pre-transition animations */
  .page-prepare-exit {
    transform: scale(0.98);
    opacity: 0.8;
    transition: none !important;
  }

  .store-hidden {
    visibility: hidden !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
  }

  .store-visible {
    visibility: visible !important;
    opacity: 1 !important;
    transition: opacity 0.3s ease !important;
  }
</style>

<!-- UPDATED AGE GATE MODAL HTML -->
<div id="age-gate-modal" class="club420-modal">
  <div class="club420-modal-box">
    <img src="https://dev.club420.com/wp-content/uploads/2025/06/CLUB420_W_logo.png" alt="Club420 Logo">
    
    <h2>Welcome</h2>
    
    <div class="age-confirm-title">Let's Confirm your Age</div>
    
    <div class="age-confirm-text">
      By clicking yes, I confirm that I am at least 21 years of age or at least 18 years of age with a valid medical recommendation.
    </div>
    
    <div class="age-buttons">
      <button id="confirm-age" class="club420-btn club420-btn--yes" onclick="confirmAgeClick()">YES, I AM 21</button>
      <button onclick="window.location.href='https://google.com'" class="club420-btn club420-btn--no">NOT YET</button>
    </div>
    
    <div class="legal-text">
      Keep out of reach of children. For use only by adults 21 years of age and older. By accessing this site, you accept the Terms of Use and Privacy Policy. Valid government issued identification required for pickup orders.
    </div>
  </div>
</div>

<!-- STORE PICKER MODAL -->
<div id="store-picker-modal" class="club420-modal">
  <div class="club420-modal-box">
    <h2>Select Your Store Location</h2>
    <label class="store-option" data-store="davis" onclick="selectStore('davis')">
      <input type="radio" name="store" value="davis" style="margin-right: 0.75rem;" onclick="selectStore('davis')">
      <strong>Davis Store</strong>
    </label>
    <label class="store-option" data-store="dixon" onclick="selectStore('dixon')">
      <input type="radio" name="store" value="dixon" style="margin-right: 0.75rem;" onclick="selectStore('dixon')">
      <strong>Dixon Store</strong>
    </label>
    <button id="enter-site-button" disabled onclick="enterSiteClick()">ENTER SITE</button>
  </div>
</div>

<!-- ULTRA-FAST TRANSITION OVERLAY -->
<div id="club420-transition" class="club420-page-transition">
  <div class="transition-content">
    <div class="transition-logo">
      <img src="https://dev.club420.com/wp-content/uploads/2025/06/black_leaf_logo_desktop.png" 
           alt="Club420 Logo" class="logo-desktop">
      <img src="https://dev.club420.com/wp-content/uploads/2025/06/black_leaf_logo_mobile.png" 
           alt="Club420 Logo" class="logo-mobile">
    </div>
    <div class="transition-text" id="transition-store-text">Switching to Dixon Store</div>
    <div class="transition-subtext">Updating your product selection...</div>
  </div>
</div>

<script>
  const davisID = '79043044-f024-4b70-8714-4fcad409f978';
  const dixonID = '7029749f-9c6d-419e-b037-5c1b566f3df9';

  // DIRECT BUTTON FUNCTIONS (Safari fix)
  function confirmAgeClick() {
    console.log('üëç Age confirmed by user (direct click)');
    localStorage.setItem('tymber-user-has-allowed-age', 'true');
    
    hideModal('age-gate-modal');
    
    if (!localStorage.getItem('last-store-selected')) {
      setTimeout(() => {
        showModal('store-picker-modal');
      }, 300);
    } else {
      showStoreSectionsSmooth();
      
      // Handle URL store filter for button functionality
      const currentUrl = new URL(window.location);
      const hasStoreFilter = currentUrl.searchParams.has('store_filter');
      
      if (!hasStoreFilter) {
        console.log('üîÑ Adding store filter for button functionality');
        const storeSelected = localStorage.getItem('last-store-selected');
        const currentStore = storeSelected === davisID ? 'davis' : 'dixon';
        currentUrl.searchParams.set('store_filter', currentStore);
        window.location.replace(currentUrl.toString());
      }
    }
  }

  function selectStore(store) {
    console.log('üè™ Store selected:', store);
    
    // Check the corresponding radio button
    const radioButton = document.querySelector(`input[name="store"][value="${store}"]`);
    if (radioButton) {
      radioButton.checked = true;
    }
    
    // Enable the Enter Site button
    const btn = document.getElementById('enter-site-button');
    if (btn) {
      btn.disabled = false;
      btn.style.background = '#f2ac1d';
      btn.style.cursor = 'pointer';
      console.log('‚úÖ Enter Site button enabled');
    }
  }

  function enterSiteClick() {
    const selectedRadio = document.querySelector('input[name="store"]:checked');
    if (selectedRadio) {
      console.log('üöÄ Entering site with store:', selectedRadio.value);
      setStoreSmoothReload(selectedRadio.value);
    } else {
      console.log('‚ùå No store selected');
    }
  }

  // SMART BOT DETECTION - BYPASS AGE GATE FOR TESTING TOOLS ONLY
  function isTestingBot() {
    const userAgent = navigator.userAgent.toLowerCase();
    const testingBots = [
      'gtmetrix',
      'pagespeed',
      'lighthouse', 
      'pingdom',
      'webpagetest',
      'websiteaudit',
      'googlebot',
      'bingbot',
      'crawler',
      'spider',
      'headless'
    ];
    
    // Check user agent
    const isBot = testingBots.some(bot => userAgent.includes(bot));
    
    // Check for headless browsers (common in testing)
    const isHeadless = navigator.webdriver === true || 
                      window.navigator.webdriver === true ||
                      window.callPhantom || 
                      window._phantom;
    
    // Check for testing URLs
    const isTestingUrl = window.location.href.includes('PageSpeed=off') ||
                         window.location.href.includes('gtmetrix') ||
                         window.location.search.includes('test=true') ||
                         window.location.search.includes('bot=true');
    
    console.log('üîç Bot detection:', {
      userAgent: userAgent.substring(0, 50) + '...',
      isBot: isBot,
      isHeadless: isHeadless,
      isTestingUrl: isTestingUrl
    });
    
    return isBot || isHeadless || isTestingUrl;
  }

  // MODAL FUNCTIONS
  function showModal(modalId) {
    console.log('üì± Showing modal:', modalId);
    
    document.querySelectorAll('.club420-modal').forEach(modal => {
      modal.classList.remove('show');
    });
    
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
      console.log('‚úÖ Modal shown:', modalId);
    } else {
      console.error('‚ùå Modal not found:', modalId);
    }
  }

  function hideModal(modalId) {
    console.log('üì± Hiding modal:', modalId);
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
      console.log('‚úÖ Modal hidden:', modalId);
    }
  }

  function hideAllModals() {
    document.querySelectorAll('.club420-modal').forEach(modal => {
      modal.classList.remove('show');
    });
    document.body.style.overflow = '';
  }

  // ULTRA-FAST STORE SWITCHING - ZERO DELAYS, ZERO FLASH
  function setStoreSmoothReload(store) {
    const id = store === 'davis' ? davisID : dixonID;
    const storeName = store === 'davis' ? 'Davis' : 'Dixon';
    
    console.log('Club420 ULTRA-FAST: Switching to', storeName);
    
    // INSTANT dark overlay - covers any flash immediately
    document.body.style.background = 'linear-gradient(135deg, #000 0%, #333 100%)';
    document.body.style.transition = 'none';
    
    // INSTANT transition overlay
    const transition = document.getElementById('club420-transition');
    const storeText = document.getElementById('transition-store-text');
    
    if (transition) {
      transition.style.transition = 'none';
      transition.classList.add('active');
    }
    
    if (storeText) {
      storeText.textContent = `Switching to ${storeName} Store`;
    }
    
    // INSTANT localStorage save
    localStorage.setItem('last-store-selected', id);
    hideAllModals();
    
    // IMMEDIATE redirect - zero delays
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('store_filter', store);
    window.location.replace(currentUrl.toString());
  }

  function showStoreSectionsSmooth() {
    const isDiviBuilder = 
      document.body.classList.contains('et-fb') || 
      document.body.classList.contains('et_pb_vb') || 
      window.location.href.includes('et_fb=1') || 
      window.location.href.includes('PageSpeed=off') || 
      document.querySelector('.et-fb') || 
      document.querySelector('#et_pb_vb') || 
      document.querySelector('.et_pb_vb_overlay');
    
    if (isDiviBuilder) {
      console.log('Club420: Divi Builder detected - showing ALL sections for editing');
      
      const allElements = document.querySelectorAll('.davis-content, .dixon-content, .davis-menu, .dixon-menu');
      allElements.forEach(el => {
        el.style.display = '';
        el.style.opacity = '1';
        el.style.visibility = 'visible';
      });
      
      return;
    }
    
    const store = localStorage.getItem('last-store-selected');
    
    const davisElements = document.querySelectorAll('.davis-content');
    const dixonElements = document.querySelectorAll('.dixon-content');
    const davisMenuItems = document.querySelectorAll('.davis-menu');
    const dixonMenuItems = document.querySelectorAll('.dixon-menu');

    [...davisElements, ...dixonElements].forEach(el => el.style.display = 'none');
    [...davisMenuItems, ...dixonMenuItems].forEach(el => el.style.display = 'none');

    if (store === davisID) {
      [...davisElements, ...davisMenuItems].forEach(el => el.style.display = '');
      console.log('Club420: Showing Davis sections');
    } else if (store === dixonID) {
      [...dixonElements, ...dixonMenuItems].forEach(el => el.style.display = '');
      console.log('Club420: Showing Dixon sections');
    }
  }

  function smoothPageEntrance() {
    const hasAdminBar = document.body.classList.contains('admin-bar') || 
                        document.querySelector('#wpadminbar') ||
                        window.location.href.includes('wp-admin');
    
    if (hasAdminBar) {
      console.log('Club420: WordPress admin bar detected - skipping body transform to avoid white gap');
      
      document.body.style.opacity = '0';
      
      setTimeout(() => {
        document.body.style.transition = 'opacity 0.4s ease';
        document.body.style.opacity = '1';
        
        setTimeout(() => {
          document.body.style.transition = '';
        }, 400);
      }, 50);
      
      return;
    }
    
    document.body.style.opacity = '0';
    document.body.style.transform = 'scale(1.02)';
    
    setTimeout(() => {
      document.body.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
      document.body.style.opacity = '1';
      document.body.style.transform = 'scale(1)';
      
      setTimeout(() => {
        document.body.style.transition = '';
      }, 400);
    }, 50);
  }

  // SMART INITIALIZATION - BOT DETECTION + FULL AGE GATE
  window.addEventListener('DOMContentLoaded', function() {
    const isTesting = isTestingBot();
    
    if (isTesting) {
      console.log('ü§ñ TESTING BOT DETECTED: Bypassing age gate for performance testing');
      
      // Force bypass for testing bots ONLY
      localStorage.setItem('tymber-user-has-allowed-age', 'true');
      localStorage.setItem('last-store-selected', davisID);
      
      // Set store filter for button functionality WITHOUT redirect
      const currentUrl = new URL(window.location);
      if (!currentUrl.searchParams.has('store_filter')) {
        currentUrl.searchParams.set('store_filter', 'davis');
        window.history.replaceState({}, '', currentUrl.toString());
      }
      
      hideAllModals();
      showStoreSectionsSmooth();
      smoothPageEntrance();
      return;
    }
    
    // REAL USERS: Full age gate compliance process
    console.log('üë§ REAL USER: Full cannabis compliance age gate process');
    
    const ageVerified = localStorage.getItem('tymber-user-has-allowed-age');
    const storeSelected = localStorage.getItem('last-store-selected');
    
    if (ageVerified !== 'true') {
      console.log('üö® Age verification required');
      showModal('age-gate-modal');
      return;
    }
    
    if (!storeSelected) {
      console.log('üè™ Store selection required');
      showModal('store-picker-modal');
      return;
    }
    
    // User is verified and has store - show content
    console.log('‚úÖ User verified, showing content');
    smoothPageEntrance();
    showStoreSectionsSmooth();
    
    // Handle URL store filter for button functionality (your original logic preserved)
    const currentUrl = new URL(window.location);
    const hasStoreFilter = currentUrl.searchParams.has('store_filter');
    
    if (!hasStoreFilter) {
      console.log('üîÑ Adding store filter for button functionality');
      const currentStore = storeSelected === davisID ? 'davis' : 'dixon';
      currentUrl.searchParams.set('store_filter', currentStore);
      window.location.replace(currentUrl.toString());
      return;
    }

    // Set up event handlers for age gate
    const confirmButton = document.getElementById('confirm-age');
    if (confirmButton) {
      confirmButton.addEventListener('click', function() {
        console.log('üëç Age confirmed by user (event listener)');
        confirmAgeClick(); // Call the direct function
      });
    }

    // Set up event handlers for store selection
    const radioButtons = document.querySelectorAll('input[name="store"]');
    radioButtons.forEach(rb => {
      rb.addEventListener('change', function() {
        const btn = document.getElementById('enter-site-button');
        btn.disabled = false;
        btn.style.background = '#f2ac1d';
        btn.style.cursor = 'pointer';
        btn.onclick = function() {
          setStoreSmoothReload(rb.value);
        };
      });
    });
  });

  // MULTIPLE DROPDOWN SUPPORT - HANDLES ALL DROPDOWNS WITH STYLED-STORE-SELECT* IDs
  window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      console.log('Club420: Initializing multiple dropdown support...');
      
      // Find all dropdowns that start with 'styled-store-select'
      const dropdowns = document.querySelectorAll('select[id^="styled-store-select"]');
      
      if (dropdowns.length === 0) {
        console.log('Club420: No styled store select dropdowns found');
        return;
      }
      
      console.log(`Club420: Found ${dropdowns.length} store dropdown(s)`);
      
      dropdowns.forEach((dropdown, index) => {
        if (!dropdown) return;
        
        console.log(`Club420: Setting up dropdown ${index + 1} with ID: ${dropdown.id}`);
        
        // Set current selection based on localStorage
        const currentStore = localStorage.getItem('last-store-selected');
        if (currentStore === davisID) {
          dropdown.value = 'davis';
        } else if (currentStore === dixonID) {
          dropdown.value = 'dixon';
        }
        
        // Add hover effect
        dropdown.addEventListener('mouseenter', function() {
          this.style.borderColor = '#f2ac1d';
          this.style.boxShadow = '0 0 15px rgba(242, 172, 29, 0.3)';
        });
        
        dropdown.addEventListener('mouseleave', function() {
          this.style.borderColor = '#fff';
          this.style.boxShadow = 'none';
        });
        
        dropdown.addEventListener('change', function() {
          const store = this.value;
          if (!store) return;
          
          console.log('Club420 Multiple Dropdown: Selected', store, 'from dropdown', this.id);
          
          // Sync all other dropdowns to match this selection
          dropdowns.forEach(dd => {
            if (dd !== this && dd.value !== store) {
              dd.value = store;
              console.log(`Club420: Synced dropdown ${dd.id} to ${store}`);
            }
          });
          
          // Use the smooth reload function from body code
          if (typeof setStoreSmoothReload === 'function') {
            setStoreSmoothReload(store);
          } else {
            console.log('setStoreSmoothReload not available, using fallback');
            // Fallback with smooth transition
            const storeId = store === 'davis' ? davisID : dixonID;
            localStorage.setItem('last-store-selected', storeId);
            
            // Add smooth page exit
            document.body.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            document.body.style.opacity = '0.8';
            document.body.style.transform = 'scale(0.98)';
            
            setTimeout(() => {
              const currentUrl = new URL(window.location);
              currentUrl.searchParams.set('store_filter', store);
              window.location.href = currentUrl.toString();
            }, 300);
          }
        });
      });
      
      console.log('Club420: Multiple dropdown support initialized successfully');
      
    }, 1200); // Slight delay to ensure body code loads first
  });

  // NUCLEAR MOBILE LOCATIONS - COMPLETELY OVERRIDES DIVI (FIXED VERSION)
  window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      console.log('Club420: Setting up NUCLEAR mobile LOCATIONS integration...');
      
      const mobileLocations = document.querySelector('ul.et_mobile_menu .menu-item-has-children.dt-hide-on-desktop');
      
      if (!mobileLocations) {
        console.log('Club420: Mobile LOCATIONS menu item not found');
        return;
      }
      
      const locationsButton = mobileLocations.querySelector('a');
      const submenu = mobileLocations.querySelector('.sub-menu');
      
      // FIXED: Text-based detection instead of position-based
      let davisLink = null;
      let dixonLink = null;

      if (submenu) {
        const menuLinks = submenu.querySelectorAll('.menu-item a');
        menuLinks.forEach(link => {
          const linkText = link.textContent.trim().toLowerCase();
          if (linkText === 'davis') {
            davisLink = link;
            console.log('Club420: Found Davis link by text');
          } else if (linkText === 'dixon') {
            dixonLink = link;
            console.log('Club420: Found Dixon link by text');
          }
        });
      }
      
      if (!locationsButton || !submenu || !davisLink || !dixonLink) {
        console.log('Club420: Required mobile LOCATIONS elements not found');
        return;
      }
      
      // Set initial state
      updateMobileLocationState();
      
      // NUCLEAR: Completely override Divi's behavior
      locationsButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        console.log('Club420: NUCLEAR - Completely blocking Divi');
        
        // Manually toggle the submenu
        mobileLocations.classList.toggle('open');
        
        if (mobileLocations.classList.contains('open')) {
          console.log('Club420: Manually opened submenu');
        } else {
          console.log('Club420: Manually closed submenu');
        }
        
        return false;
      }, true); // Capture phase
      
      // Davis click handler
      davisLink.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Club420: Mobile Davis selected');
        selectMobileStore('davis', 'Davis');
      });
      
      // Dixon click handler  
      dixonLink.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Club420: Mobile Dixon selected');
        selectMobileStore('dixon', 'Dixon');
      });
      
      function selectMobileStore(store, storeName) {
        // Update selected states for your CSS
        const davisItem = davisLink.closest('.menu-item');
        const dixonItem = dixonLink.closest('.menu-item');
        
        davisItem.classList.remove('selected');
        dixonItem.classList.remove('selected');
        
        if (store === 'davis') {
          davisItem.classList.add('selected');
        } else {
          dixonItem.classList.add('selected');
        }
        
        // Close the dropdown first
        mobileLocations.classList.remove('open');
        
        // Update button text to show the newly selected store
        ensureButtonTextIsLocations();
        
        console.log('Club420: Mobile store switching to:', store);
        setStoreSmoothReload(store);
      }
      
      function updateMobileLocationState() {
        const currentStore = localStorage.getItem('last-store-selected');
        const davisItem = davisLink.closest('.menu-item');
        const dixonItem = dixonLink.closest('.menu-item');
        
        davisItem.classList.remove('selected');
        dixonItem.classList.remove('selected');
        
        if (currentStore === '7029749f-9c6d-419e-b037-5c1b566f3df9') { // Dixon ID
          dixonItem.classList.add('selected');
          console.log('Club420: Mobile initial state - Dixon selected');
        } else {
          davisItem.classList.add('selected');
          console.log('Club420: Mobile initial state - Davis selected');
        }
        
        // FIXED: Always keep button text as "Locations"
        ensureButtonTextIsLocations();
      }
      
      function ensureButtonTextIsLocations() {
        if (locationsButton) {
          // Get current store from localStorage
          const currentStore = localStorage.getItem('last-store-selected');
          const dixonID = '7029749f-9c6d-419e-b037-5c1b566f3df9';
          
          // Determine current store name
          const storeName = (currentStore === dixonID) ? 'Dixon' : 'Davis';
          
          // Clear existing content
          locationsButton.innerHTML = '';
          
          // Create container for the text content
          const textContainer = document.createElement('div');
          textContainer.style.display = 'flex';
          textContainer.style.alignItems = 'center';
          textContainer.style.gap = '10px';
          
          // Add store name span
          const storeSpan = document.createElement('span');
          storeSpan.className = 'store-name';
          storeSpan.textContent = storeName;
          storeSpan.style.color = '#fff';
          storeSpan.style.fontWeight = '600';
          
          // Add "Change Location" span with MULTIPLE yellow underline methods
          const changeSpan = document.createElement('span');
          changeSpan.className = 'change-location';
          changeSpan.textContent = 'Change Location';
          changeSpan.style.color = '#fff';
          changeSpan.style.fontWeight = '400';
          changeSpan.style.textDecoration = 'underline';
          changeSpan.style.textDecorationColor = '#f2ac1d';
          changeSpan.style.textUnderlineOffset = '4px';
          changeSpan.style.borderBottom = '2px solid #f2ac1d'; // Fallback method
          changeSpan.style.paddingBottom = '2px';
          changeSpan.style.position = 'relative';
          
          // Add spans to container
          textContainer.appendChild(storeSpan);
          textContainer.appendChild(changeSpan);
          
          // Add container to button
          locationsButton.appendChild(textContainer);
          
          console.log(`Club420: DEBUGGING - Created button with spans:`, {
            storeName,
            storeSpanClass: storeSpan.className,
            changeSpanClass: changeSpan.className,
            buttonHTML: locationsButton.innerHTML
          });
          console.log(`Club420: Yellow underline methods applied - CSS + border-bottom fallback`);
        }
      }
      
      console.log('Club420: NUCLEAR mobile LOCATIONS integration complete! üì±üí£‚úÖ');
      
    }, 2000);
  });

  // ========================================= 
  // SHOP MENU COLLAPSE - NEW ADDITION
  // ========================================= 
  window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      console.log('Club420: Initializing shop menu collapse...');
      
      // Only target shop categories (exclude LOCATIONS with dt-hide-on-desktop)
      const shopMenuItems = document.querySelectorAll('ul.et_mobile_menu .menu-item-has-children:not(.dt-hide-on-desktop)');
      
      if (shopMenuItems.length === 0) {
        console.log('Club420: No shop menu items found');
        return;
      }
      
      console.log(`Club420: Found ${shopMenuItems.length} shop menu items to make collapsible`);
      
      shopMenuItems.forEach(function(menuItem) {
        const menuLink = menuItem.querySelector('a');
        const submenu = menuItem.querySelector('.sub-menu');
        
        if (!menuLink || !submenu) return;
        
        // Add click handler for toggle
        menuLink.addEventListener('click', function(e) {
          console.log('Club420: Toggling shop submenu for:', menuLink.textContent.trim());
          
          // Close other shop submenus (accordion effect)
          shopMenuItems.forEach(function(otherItem) {
            if (otherItem !== menuItem) {
              otherItem.classList.remove('shop-expanded');
            }
          });
          
          // Toggle current submenu
          menuItem.classList.toggle('shop-expanded');
          
          // If submenu is now open, prevent navigation
          if (menuItem.classList.contains('shop-expanded')) {
            e.preventDefault();
            e.stopPropagation();
          }
          // If submenu is closed, allow normal navigation
        });
        
        // Close submenu when clicking submenu items
        const submenuLinks = submenu.querySelectorAll('a');
        submenuLinks.forEach(function(link) {
          link.addEventListener('click', function() {
            // Allow normal navigation for submenu items
            console.log('Club420: Navigating to submenu item:', link.textContent.trim());
          });
        });
      });
      
      console.log('Club420: Shop menu collapse initialized successfully');
      
    }, 2500); // Run after LOCATIONS system is initialized
  });

  // Close shop menus when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('ul.et_mobile_menu')) {
      const expandedShopItems = document.querySelectorAll('ul.et_mobile_menu .menu-item-has-children.shop-expanded');
      expandedShopItems.forEach(function(item) {
        if (!item.classList.contains('dt-hide-on-desktop')) {
          item.classList.remove('shop-expanded');
        }
      });
    }
  });

  window.setStore = setStoreSmoothReload;

  // MENU MANAGER (unchanged)
  window.Club420MenuManager = {
    storeMapping: {
      '79043044-f024-4b70-8714-4fcad409f978': 'f-street',
      '7029749f-9c6d-419e-b037-5c1b566f3df9': 'highway-80'
    },
    
    categories: {
      'flower': 'flower',
      'cartridges': 'cartridge', 
      'edibles': 'edible',
      'prerolls': 'preroll',
      'extract': 'extract',
      'wellness': 'tincture',
      'merchandise': 'merch',
      'shop-all': ''
    },
    
    getDomain: function() {
      const hostname = window.location.hostname;
      if (hostname.includes('dev.')) {
        return 'https://club420.com';
      }
      return 'https://club420.com';
    },
    
    getMenuURL: function(category) {
      const selectedStoreID = localStorage.getItem('last-store-selected');
      const ageVerified = localStorage.getItem('tymber-user-has-allowed-age');
      
      if (!selectedStoreID || ageVerified !== 'true') return '/';
      
      const storeSlug = this.storeMapping[selectedStoreID];
      if (!storeSlug) return '/';
      
      const categorySlug = this.categories[category];
      const domain = this.getDomain();
      
      if (category === 'shop-all' || categorySlug === '') {
        return domain + '/menu/' + storeSlug + '/?order=-price';
      }
      
      if (!categorySlug) {
        return domain + '/menu/' + storeSlug + '/';
      }
      
      return domain + '/menu/' + storeSlug + '/categories/' + categorySlug + '/?order=-price';
    },
    
    goToCategory: function(category) {
      const url = this.getMenuURL(category);
      console.log('Club420: Navigating to:', category, '‚Üí', url);
      window.location.href = url;
    }
  };

  // TEXT MENU NAVIGATION (unchanged)
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      console.log('Club420: Starting text menu integration...');
      
      let hooked = 0;
      
      const allLinks = document.querySelectorAll('a');
      allLinks.forEach(link => {
        const text = link.textContent.toLowerCase().trim();
        const href = link.getAttribute('href') || '';
        
        if (href.startsWith('#') && Club420MenuManager.categories.hasOwnProperty(href.substring(1))) {
          return;
        }
        
        if (text === 'flower' || text === 'cartridges' || text === 'edibles' || 
            text === 'pre-rolls' || text === 'prerolls' || text === 'extracts' || 
            text === 'extract' || text === 'shop all' || text === 'all' || text === 'shop now') {
          
          link.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (text === 'flower') Club420MenuManager.goToCategory('flower');
            else if (text === 'cartridges') Club420MenuManager.goToCategory('cartridges');
            else if (text === 'edibles') Club420MenuManager.goToCategory('edibles');
            else if (text === 'pre-rolls' || text === 'prerolls') Club420MenuManager.goToCategory('prerolls');
            else if (text === 'extracts' || text === 'extract') Club420MenuManager.goToCategory('extract');
            else if (text === 'shop all' || text === 'all' || text === 'shop now') Club420MenuManager.goToCategory('shop-all');
          }, { passive: false });
          hooked++;
        }
      });
      
      console.log('Club420: Hooked', hooked, 'text menu elements');
      
    }, 3000);
  });

  window.addEventListener('popstate', function() {
    setTimeout(showStoreSectionsSmooth, 100);
  });

  window.addEventListener('storage', function(e) {
    if (e.key === 'last-store-selected') {
      setTimeout(showStoreSectionsSmooth, 100);
    }
  });

  window.addEventListener('load', function() {
    setTimeout(showStoreSectionsSmooth, 300);
  });

  console.log('üçÉ Club420: Complete system active - NUCLEAR mobile LOCATIONS completely overrides Divi! üì±üí£‚úÖ');
  console.log('üõçÔ∏è Club420: Shop menu collapse system loaded');
</script>

<script>
// Club420 Divi Menu Integration
document.addEventListener('DOMContentLoaded', function() {
  // Wait for both Club420MenuManager and Divi menu to load
  setTimeout(function() {
    console.log('Club420: Integrating with Divi menu...');
    
    if (window.Club420MenuManager) {
      // Find all menu links with category anchors
      const categoryLinks = document.querySelectorAll('a[href^="#"]');
      
      categoryLinks.forEach(function(link) {
        const href = link.getAttribute('href');
        if (!href || href === '#') return;
        
        const category = href.substring(1); // Remove the #
        
        // Map to Club420MenuManager categories
        const categoryMapping = {
          'shop-all': 'shop-all',
          'flower': 'flower',
          'cartridges': 'cartridges',
          'prerolls': 'prerolls',
          'edibles': 'edibles',
          'extract': 'extract'
        };
        
        if (categoryMapping[category]) {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Club420: Divi menu navigation to', category);
            window.Club420MenuManager.goToCategory(categoryMapping[category]);
          });
          
          console.log('Club420: Hooked Divi menu link', category);
        }
      });
      
      console.log('Club420: Divi menu integration complete!');
    } else {
      console.warn('Club420: MenuManager not found, retrying...');
      // Retry after a short delay
      setTimeout(arguments.callee, 1000);
    }
  }, 2000);
});
</script>
